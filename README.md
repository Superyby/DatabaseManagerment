# æ–°å¹´å¿«ä¹ğŸ¥³
# DatabaseManager

é«˜æ€§èƒ½æ•°æ®åº“ç®¡ç†åç«¯ï¼ŒåŸºäº Rust + Axum + SQLx å¾®æœåŠ¡æ¶æ„ã€‚

## é¡¹ç›®ç»“æ„

```text
DatabaseManager/
â”œâ”€â”€ Cargo.toml                 # Workspace é…ç½®
â”œâ”€â”€ Dockerfile                 # å¤šé˜¶æ®µæ„å»º
â”œâ”€â”€ docker-compose.yml         # å®¹å™¨ç¼–æ’
â”‚
â”œâ”€â”€ common/                    # å…±äº«æ¨¡å—
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ config.rs          # é…ç½®ç®¡ç†
â”‚       â”œâ”€â”€ errors.rs          # é”™è¯¯å¤„ç†
â”‚       â”œâ”€â”€ response.rs        # API å“åº”
â”‚       â”œâ”€â”€ middleware/        # ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚       â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ gateway/                   # API ç½‘å…³ (ç«¯å£ 8080)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.rs            # å…¥å£
â”‚       â”œâ”€â”€ routes.rs          # è·¯ç”±
â”‚       â”œâ”€â”€ handlers.rs        # å¤„ç†å™¨
â”‚       â””â”€â”€ proxy.rs           # è¯·æ±‚ä»£ç†
â”‚
â”œâ”€â”€ connection-service/        # è¿æ¥ç®¡ç†æœåŠ¡ (ç«¯å£ 8081)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.rs            # å…¥å£
â”‚       â”œâ”€â”€ service.rs         # ä¸šåŠ¡é€»è¾‘
â”‚       â””â”€â”€ pool_manager.rs    # è¿æ¥æ± ç®¡ç†
â”‚
â”œâ”€â”€ query-service/             # SQL æŸ¥è¯¢æœåŠ¡ (ç«¯å£ 8082)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.rs            # å…¥å£
â”‚       â””â”€â”€ service.rs         # æŸ¥è¯¢æ‰§è¡Œ
â”‚
â””â”€â”€ ai-service/                # AI æ™ºèƒ½æŸ¥è¯¢æœåŠ¡ (ç«¯å£ 8083)
    â””â”€â”€ src/
        â”œâ”€â”€ main.rs            # å…¥å£
        â”œâ”€â”€ models.rs          # AI æ•°æ®æ¨¡å‹
        â”œâ”€â”€ service.rs         # AI ä¸šåŠ¡é€»è¾‘
        â”œâ”€â”€ handlers.rs        # HTTP å¤„ç†å™¨
        â””â”€â”€ state.rs           # åº”ç”¨çŠ¶æ€
```

## æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¢æˆ·ç«¯ (å‰ç«¯/API)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ HTTP/JSON
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Gateway (8080)                           â”‚
â”‚              API ç½‘å…³ Â· è·¯ç”±è½¬å‘ Â· èšåˆå¥åº·æ£€æŸ¥                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                  â”‚
         â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Connection      â”‚  â”‚ Query           â”‚  â”‚ AI              â”‚
â”‚ Service (8081)  â”‚  â”‚ Service (8082)  â”‚  â”‚ Service (8083)  â”‚
â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚
â”‚ Â· è¿æ¥ç®¡ç†       â”‚  â”‚ Â· SQL æ‰§è¡Œ      â”‚  â”‚ Â· Text2SQL      â”‚
â”‚ Â· è¿æ¥æ± ç®¡ç†     â”‚  â”‚ Â· ç»“æœè§£æ      â”‚  â”‚ Â· è¯­ä¹‰ç†è§£       â”‚
â”‚ Â· è¿æ¥æµ‹è¯•       â”‚  â”‚ Â· SQL æ ¡éªŒ      â”‚  â”‚ Â· RAG å¢å¼º      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤–éƒ¨æ•°æ®åº“                             â”‚
â”‚     MySQL Â· PostgreSQL Â· SQLite Â· Redis Â· MongoDB ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æŸ¥çœ‹å¸®åŠ©
./start.sh help

# å•å®¹å™¨æ¨¡å¼ï¼ˆå¼€å‘æ¨èï¼Œå†…å­˜ ~200MBï¼‰
./start.sh single

# å¤šå®¹å™¨æ¨¡å¼ï¼ˆç”Ÿäº§æ¨èï¼‰
./start.sh multi

# æœ¬åœ°ç›´æ¥è¿è¡Œï¼ˆä¸éœ€è¦ Dockerï¼‰
./start.sh local

# åœæ­¢æœåŠ¡
./start.sh stop

# æŸ¥çœ‹æ—¥å¿—
./start.sh logs
```

### éƒ¨ç½²æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | å®¹å™¨æ•° | å†…å­˜ | å‘½ä»¤ |
|------|--------|------|------|
| å•å®¹å™¨ | 1 | ~20MB | `./start.sh single` |
| å¤šå®¹å™¨ | 4 | ~40MB | `./start.sh multi` |
| æœ¬åœ° | 0 | ~15MB | `./start.sh local` |

### æ‰‹åŠ¨ Docker éƒ¨ç½²

```bash
# å•å®¹å™¨æ¨¡å¼
docker compose -f docker-compose.single.yml up -d

# å¤šå®¹å™¨æ¨¡å¼
docker compose up -d
```

### æœ¬åœ°ç¼–è¯‘è¿è¡Œ

```bash
# æ£€æŸ¥ç¼–è¯‘
cargo check --workspace

# æ„å»ºæ‰€æœ‰æœåŠ¡
cargo build --workspace --release

# è¿è¡Œå•ä¸ªæœåŠ¡
cargo run -p ai-service
```

## API ç«¯ç‚¹

### Gateway (8080)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/health` | ç½‘å…³å¥åº·æ£€æŸ¥ |
| GET | `/api/health/all` | èšåˆå¥åº·æ£€æŸ¥ |

### Connection Service (8081)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/connections` | åˆ—å‡ºæ‰€æœ‰è¿æ¥ |
| POST | `/api/connections` | åˆ›å»ºè¿æ¥ |
| GET | `/api/connections/:id` | è·å–è¿æ¥è¯¦æƒ… |
| DELETE | `/api/connections/:id` | åˆ é™¤è¿æ¥ |
| POST | `/api/connections/:id/test` | æµ‹è¯•è¿æ¥ |

### Query Service (8082)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/query` | æ‰§è¡Œ SQL æŸ¥è¯¢ |
| GET | `/api/health` | å¥åº·æ£€æŸ¥ |

### AI Service (8083)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/ai/query` | è‡ªç„¶è¯­è¨€è½¬ SQL |
| POST | `/api/ai/clarify` | æ¾„æ¸…å›å¤ |
| POST | `/api/ai/validate` | SQL æ ¡éªŒ |
| GET | `/api/health` | å¥åº·æ£€æŸ¥ |

## ç¯å¢ƒå˜é‡

### é€šç”¨é…ç½®

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `SERVER_HOST` | `0.0.0.0` | æœåŠ¡ç›‘å¬åœ°å€ |
| `SERVER_PORT` | æœåŠ¡ç‰¹å®š | æœåŠ¡ç«¯å£ |
| `RUST_LOG` | `info` | æ—¥å¿—çº§åˆ« |

### AI Service é…ç½®

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `LLM_BASE_URL` | `https://api.openai.com/v1` | LLM API åœ°å€ |
| `LLM_API_KEY` | - | LLM API å¯†é’¥ |
| `LLM_DEFAULT_MODEL` | `gpt-4o-mini` | å¿«é€Ÿæ¨¡å‹ |
| `LLM_HIGH_PRECISION_MODEL` | `gpt-4o` | é«˜ç²¾åº¦æ¨¡å‹ |

## æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| Web æ¡†æ¶ | Axum 0.8 | é«˜æ€§èƒ½å¼‚æ­¥ Web æ¡†æ¶ |
| å¼‚æ­¥è¿è¡Œæ—¶ | Tokio | å…¨åŠŸèƒ½å¼‚æ­¥è¿è¡Œæ—¶ |
| æ•°æ®åº“ | SQLx | å¤šæ•°æ®åº“æ”¯æŒ |
| æ—¥å¿— | tracing | ç»“æ„åŒ–æ—¥å¿— |
| API æ–‡æ¡£ | Utoipa | OpenAPI è‡ªåŠ¨ç”Ÿæˆ |
| å®¹å™¨åŒ– | Docker | å¤šé˜¶æ®µæ„å»º |

## ç›¸å…³æ–‡æ¡£

### æŠ€æœ¯æ–‡æ¡£ (docs/)

- [æ–‡æ¡£ç´¢å¼•](./docs/README.md) - å®Œæ•´æ–‡æ¡£å¯¼èˆª

**æ¶æ„è®¾è®¡**
- [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](./docs/architecture/overview.md)
- [å¾®æœåŠ¡è®¾è®¡](./docs/architecture/microservices.md)
- [AI åŠŸèƒ½æ¶æ„](./docs/architecture/ai-architecture.md)

**æœåŠ¡æ–‡æ¡£**
- [Gateway](./docs/services/gateway.md)
- [Connection Service](./docs/services/connection-service.md)
- [Query Service](./docs/services/query-service.md)
- [AI Service](./docs/services/ai-service.md)

**å¼€å‘æŒ‡å—**
- [å¿«é€Ÿå¼€å§‹](./docs/development/getting-started.md)
- [ç¼–ç è§„èŒƒ](./docs/development/coding-standards.md)
- [éƒ¨ç½²æŒ‡å—](./docs/development/deployment.md)
- [API å‚è€ƒ](./docs/api/api-reference.md)

### è®¾è®¡æ–‡æ¡£

- [AI æ¶æ„è®¾è®¡](./AI_æ¶æ„è®¾è®¡.md) - AI åŠŸèƒ½è¯¦ç»†è®¾è®¡ä¸å®ç°è¿›åº¦
