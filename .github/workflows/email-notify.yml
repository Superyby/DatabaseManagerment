name: ğŸ“§ DatabaseManagerment æäº¤é‚®ä»¶é€šçŸ¥


on:
  push:
    branches: [ main, master ]  # ç›‘å¬ä¸»åˆ†æ”¯çš„æ¨é€


jobs:
  send_email_notification:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²


      - name: ğŸ“ æå–æäº¤ä¿¡æ¯
        id: get_commit_info
        run: |
          # è·å–æœ€è¿‘ä¸€æ¬¡æäº¤çš„å…³é”®ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          COMMIT_HASH=$(git log -1 --pretty=format:"%h")
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          
          # è·å–æ–‡ä»¶å˜æ›´ç»Ÿè®¡ï¼ˆé™åˆ¶è¡Œæ•°é˜²è¶…é•¿ï¼‰
          if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
            CHANGES=$(git diff --stat HEAD~1 HEAD | head -n 15)
          else
            CHANGES="âœ¨ é¦–æ¬¡æäº¤"
          fi
          
          # å†™å…¥ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_URL=$COMMIT_URL" >> $GITHUB_ENV
          echo "CHANGES<<EOF" >> $GITHUB_ENV
          echo "$CHANGES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV


      - name: âœ‰ï¸ é€šè¿‡ 163 é‚®ç®±å‘é€é€šçŸ¥
        uses: dawidd6/action-send-mail@v3
        with:
          # --- SMTP é…ç½®ï¼ˆ163 é‚®ç®±ä¸“ç”¨ï¼‰---
          server_address: smtp.163.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          secure: true  # å¯ç”¨ SSL åŠ å¯†ï¼ˆ163 å¼ºåˆ¶è¦æ±‚ï¼‰


          # --- é‚®ä»¶å†…å®¹ ---
          subject: "ğŸš€ æ–°ä»£ç æäº¤ | DatabaseManagerment | ${{ env.COMMIT_HASH }}"
          body: |
            ğŸ“¬ GitHub è‡ªåŠ¨é€šçŸ¥
            
            ğŸ“ ä»“åº“ï¼š${{ github.repository }}
            ğŸŒ¿ åˆ†æ”¯ï¼š${{ github.ref_name }}
            ğŸ‘¤ æäº¤è€…ï¼š${{ env.COMMIT_AUTHOR }}
            ğŸ•’ UTC æ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
            
            ğŸ“Œ æäº¤ä¿¡æ¯ï¼š
            ${{ env.COMMIT_MSG }}
            
            ğŸ“Š å˜æ›´æ¦‚è§ˆï¼š
            ${{ env.CHANGES }}
            
            ğŸ”— æŸ¥çœ‹è¯¦æƒ…ï¼š
            ${{ env.COMMIT_URL }}
            
            â€”â€” æœ¬é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œæ— éœ€å›å¤ã€‚
          to: ${{ secrets.NOTIFICATION_EMAILS }}
          from: GitHubå°åŠ©æ‰‹ <${{ secrets.MAIL_USERNAME }}>
          reply_to: ${{ secrets.MAIL_USERNAME }}
